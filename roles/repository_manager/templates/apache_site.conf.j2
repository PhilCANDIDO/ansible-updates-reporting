<VirtualHost *:80>
    ServerName {{ ansible_fqdn | default(ansible_hostname) }}
    ServerAlias {{ ansible_hostname }}
    DocumentRoot {{ repository_base_path }}
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Main directory configuration
    <Directory {{ repository_base_path }}>
        Options Indexes FollowSymLinks
        AllowOverride None
        {% if ansible_distribution_major_version | int >= 8 and ansible_os_family == 'RedHat' %}
        Require all granted
        {% elif ansible_distribution_major_version | int >= 2.4 and ansible_os_family == 'Debian' %}
        Require all granted
        {% else %}
        Order allow,deny
        Allow from all
        {% endif %}
        
        # Enable directory browsing
        Options +Indexes
        IndexOptions FancyIndexing HTMLTable SuppressDescription
    </Directory>
    
    # JSON files with proper content type
    <FilesMatch "\.json$">
        Header set Content-Type "application/json"
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
    
    # Excel files
    <FilesMatch "\.xlsx?$">
        Header set Content-Type "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        Header set Content-Disposition "attachment"
    </FilesMatch>
    
    # HTML reports with security headers
    <FilesMatch "\.html$">
        Header set Content-Type "text/html"
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </FilesMatch>
    
    # Logging
    {% if webserver_security.access_log %}
    {% if ansible_os_family == 'RedHat' %}
    CustomLog {{ current_webserver_log_path }}/updates-reports.access.log combined
    {% else %}
    CustomLog {{ current_webserver_log_path }}/updates-reports.access.log combined
    {% endif %}
    {% endif %}
    
    {% if webserver_security.error_log %}
    ErrorLog {{ current_webserver_log_path }}/updates-reports.error.log
    {% endif %}
</VirtualHost>