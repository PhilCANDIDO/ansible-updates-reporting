---
# AWX Execution Mode Detection and Configuration
# This file provides AWX-aware variables for compatible execution

# Detect if running in AWX/Tower environment
awx_execution_mode: "{{ lookup('env', 'AWX_HOST') | length > 0 }}"
tower_execution_mode: "{{ lookup('env', 'TOWER_HOST') | length > 0 }}"
is_awx_environment: "{{ awx_execution_mode or tower_execution_mode }}"

# AWX/Tower specific variables
awx_job_id: "{{ lookup('env', 'JOB_ID') | default('local_' + ansible_date_time.epoch) }}"
awx_job_template_id: "{{ lookup('env', 'JOB_TEMPLATE_ID') | default('none') }}"
awx_inventory_id: "{{ lookup('env', 'INVENTORY_ID') | default('none') }}"
awx_project_revision: "{{ lookup('env', 'PROJECT_REVISION') | default('local') }}"

# Artifact directories
awx_artifacts_dir: "{{ lookup('env', 'AWX_ARTIFACTS_DIR') | default('/tmp/awx_artifacts') }}"
awx_isolated_dir: "{{ lookup('env', 'AWX_ISOLATED_DIR') | default('/tmp/awx_isolated') }}"

# Storage paths based on execution mode
reports_storage_path: "{{ awx_artifacts_dir if is_awx_environment else local_reports_path | default('/tmp/ansible-reports') }}"
temp_storage_path: "{{ awx_artifacts_dir + '/temp' if is_awx_environment else '/tmp' }}"
consolidated_reports_path: "{{ reports_storage_path }}/consolidated"
host_reports_path: "{{ reports_storage_path }}/hosts"

# AWX-specific settings
use_awx_artifacts: "{{ is_awx_environment }}"
use_fact_caching: "{{ is_awx_environment }}"
use_set_stats: "{{ is_awx_environment }}"

# Disable features incompatible with AWX
disable_localhost_delegation: "{{ is_awx_environment }}"
disable_local_file_operations: "{{ is_awx_environment }}"
use_containerized_excel: "{{ is_awx_environment and container_runtime is defined }}"

# Container runtime detection
container_runtime: "{{ 'podman' if lookup('pipe', 'which podman 2>/dev/null', errors='ignore') else ('docker' if lookup('pipe', 'which docker 2>/dev/null', errors='ignore') else '') }}"

# AWX callback and notification settings
awx_base_url: "{{ lookup('env', 'AWX_HOST') | default('http://localhost') }}"
awx_token: "{{ lookup('env', 'TOWER_OAUTH_TOKEN') | default('') }}"
use_awx_notifications: "{{ is_awx_environment and awx_token | length > 0 }}"

# Fact caching configuration for AWX
fact_cache_prefix: "updates_{{ awx_job_id }}_"
fact_cache_timeout: 3600

# Debug mode
awx_debug_mode: "{{ lookup('env', 'AWX_DEBUG') | default('false') | bool }}"

# Compatibility flags
maintain_backward_compatibility: true
enable_dual_mode_execution: true